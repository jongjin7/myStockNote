# 주식 노트 개발 및 운영 프로세스 가이드 (Workflow & Process Guide)

이 문서는 [PRD v2.0](./prd.md)을 기반으로, 실제 사용자의 데이터를 어떻게 입력받을 것인지(입력 프로세스)와 개발을 어떻게 진행할 것인지(개발 워크플로우)를 상세히 정의한다.

**버전:** v2.0 (Supabase 기반)  
**작성일:** 2026-01-31

---

## 1. 사용자 인증 프로세스

### 1.1 회원가입 플로우
1. **시작**: 로그인 페이지에서 [회원가입] 링크 클릭
2. **정보 입력**:
   - 이메일 (필수)
   - 비밀번호 (필수, 최소 8자)
   - 이름 (선택)
3. **이메일 인증**: Supabase Auth 이메일 확인
4. **완료**: 자동 로그인 후 대시보드로 이동

### 1.2 로그인 플로우
1. **이메일/비밀번호 로그인**:
   - 이메일, 비밀번호 입력
   - [로그인] 버튼 클릭
   - 세션 생성 (7일 유지)
2. **소셜 로그인 (Google)**:
   - [Google 로그인] 버튼 클릭
   - Google OAuth 인증
   - 자동 회원가입 또는 로그인
3. **자동 로그인**:
   - 세션 유효 시 자동 로그인
   - 토큰 만료 시 재로그인 유도

### 1.3 비밀번호 재설정
1. **시작**: 로그인 페이지에서 [비밀번호 찾기] 클릭
2. **이메일 입력**: 가입한 이메일 주소 입력
3. **이메일 확인**: Supabase Auth 재설정 이메일 발송
4. **새 비밀번호 설정**: 이메일 링크 클릭 후 새 비밀번호 입력

---

## 2. 데이터 입력 프로세스 (Input Process)

사용자의 수동 입력 편의성을 극대화하여 '기록하는 즐거움'을 주는 것을 목표로 한다.

### 2.1 계좌 및 자산 갱신 프로세스
1. **갱신 주기**: 주 1회 또는 매매 직후 권장
2. **입력 경로**: 대시보드 요약 카드 또는 [계좌 관리] 메뉴
3. **핵심 UI**: 
   - 현재 예수금(Cash Balance)을 즉시 수정할 수 있는 인라인 에디팅 기능
   - 마지막 업데이트 시각을 자동으로 기록하여 '자산 상태의 신선도'를 시각화
   - **동기화 상태 표시**: 저장 중/저장 완료/동기화 실패 아이콘
4. **데이터 동기화**:
   - 수정 즉시 Supabase에 저장
   - 다른 기기에 실시간 반영 (Supabase Realtime)

### 2.2 종목 등록 프로세스

#### 2.2.1 보유 종목 (Holdings) 등록
1. **시작**: [종목 추가] 버튼 클릭 → '보유 종목' 선택
2. **정보 입력**: 종목명, 종목코드(선택), 수량, 단가, 계좌 선택
3. **저장**: Supabase DB에 저장 후 실시간 동기화
4. **저장 후 연계**: "종목이 추가되었습니다. 매수 이유를 기록해볼까요?" Contextual Prompt 제공

#### 2.2.2 관심 종목 (Watchlist) 등록
1. **시작**: [종목 추가] 버튼 클릭 → '관심 종목' 선택
2. **정보 입력**: 종목명, 종목코드(선택). (수량/단가/계좌 불필요)
3. **저장**: Supabase DB에 저장 후 실시간 동기화
4. **저장 후 연계**: "관심 종목이 등록되었습니다. 리서치 자료를 남겨보세요." Contextual Prompt 제공

### 2.3 투자 판단 및 리서치 아카이빙 (핵심)

#### 2.3.1 텍스트 노트 작성
1. **분석 내용 복사/붙여넣기**:
   - 종목 분석 텍스트를 `buyReason` 또는 `currentThought` 필드에 붙여넣기
   - 형식이 유지되도록 보존 (줄바꿈, 들여쓰기 등)
2. **구조화된 입력**:
   - 매수 이유 (buyReason)
   - 기대 시나리오 (expectedScenario)
   - 리스크 (risks)
3. **자동 저장**: Supabase DB에 저장 후 실시간 동기화

#### 2.3.2 이미지 첨부 (Supabase Storage)
1. **이미지 선택**:
   - 드래그 앤 드롭으로 리포트, 차트 캡처본 업로드
   - 또는 파일 선택 버튼 클릭
2. **업로드 프로세스**:
   - 클라이언트에서 이미지 리사이징 (최대 1920px)
   - Supabase Storage에 업로드
   - Public URL 생성
   - DB에 메타데이터 저장 (fileName, fileSize, storageUrl)
3. **지원 형식**: JPG, PNG, WebP, HEIC (최대 10MB/파일)
4. **썸네일 표시**: 업로드된 이미지 즉시 표시

### 2.4 매매 및 사후 회고 프로세스
1. **매매 발생 시**: 사용자가 수량/단가 정보를 업데이트
2. **회고 트리거**: 상태가 `SOLD`(전량 매도)로 변경되는 시점에 **'매도 복기 노트'** 작성 유도
3. **회고 내용**: 
   - "당초 시나리오와 맞았는가?"
   - "어떤 감정이 의사결정에 영향을 주었는가?"
   - 가이드 제공
4. **데이터 동기화**: 회고 노트 저장 후 모든 기기에 동기화

---

## 3. 데이터 동기화 프로세스

### 3.1 실시간 동기화 (Supabase Realtime)
1. **자동 동기화**:
   - 한 기기에서 데이터 수정 시 다른 기기에 즉시 반영
   - Supabase Realtime 구독을 통한 실시간 업데이트
2. **동기화 상태 표시**:
   - 저장 중: 회전 아이콘
   - 저장 완료: 체크 아이콘 (2초 후 사라짐)
   - 동기화 실패: 경고 아이콘 + 재시도 버튼

### 3.2 오프라인 모드 처리
1. **네트워크 감지**:
   - 온라인/오프라인 상태 자동 감지
   - 상태 변경 시 UI에 표시
2. **오프라인 동작**:
   - 로컬 캐시(LocalStorage)에서 데이터 조회
   - 수정 사항은 로컬에 임시 저장
   - "오프라인 모드" 배너 표시
3. **온라인 복귀**:
   - 자동으로 Supabase와 동기화
   - 충돌 발생 시 Last Write Wins 정책 적용
   - 동기화 완료 알림

### 3.3 충돌 해결 (Last Write Wins)
1. **충돌 감지**: 동일 데이터를 여러 기기에서 동시 수정
2. **해결 방법**: 타임스탬프 기반 최신 데이터 우선
3. **사용자 알림**: "다른 기기에서 수정된 내용이 있습니다" 메시지 표시

---

## 4. 개발 워크플로우 (Development Workflow)

AI 에이전트와 인간 개발자가 협업하여 고품질의 결과물을 신속하게 도출하기 위한 표준 절차이다.

### 4.1 개발 사이클 (Iterative Development)
1. **Feature Definition**: 구현할 기능의 PRD 요구사항과 데이터 모델(types)을 먼저 검토
2. **Implementation**: 
   - **Styling**: Tailwind 4 기반 프리미엄 디자인 적용 (Glassmorphism, Vibrant Colors)
   - **Logic**: TypeScript의 엄격한 타입 체크(`VerbatimModuleSyntax`) 준수
   - **Backend**: Supabase Client SDK를 사용한 데이터 CRUD
3. **Local Testing**: `pnpm dev`를 통해 코드 변경사항 실시간 반영 확인
4. **Agent Verification**: `browser_subagent`를 사용하여 렌더링 검증, 콘솔 에러 체크, 스크린샷 캡처 수행

### 4.2 코드 가이드라인

#### 4.2.1 컴포넌트 구조
- **Components**: 재사용 가능한 원자(Atomic) 단위 컴포넌트 개발
- **Pages**: 라우팅 단위 페이지 컴포넌트
- **Contexts**: 전역 상태 관리 (AppContext, AuthContext)

#### 4.2.2 상태 관리
- **서버 상태**: React Query를 사용한 Supabase 데이터 캐싱 및 동기화
- **클라이언트 상태**: React Context API
- **로컬 캐시**: LocalStorage (오프라인 모드용)

#### 4.2.3 에러 처리
- **네트워크 에러**: 
  - 재시도 로직 (최대 3회)
  - 사용자 친화적 에러 메시지
  - 오프라인 모드로 전환
- **인증 에러**:
  - 토큰 만료 시 자동 갱신
  - 갱신 실패 시 재로그인 유도
- **Supabase 에러**:
  - 에러 타입별 처리
  - 로그 기록 (개발 환경)

### 4.3 UI/UX 원칙
- **Aesthetics**: 단순한 MVP를 넘어 'Premium Look & Feel'을 지향
- **Interactivity**: 버튼 호버, 페이지 전환 시 부드러운 애니메이션(`framer-motion` 또는 CSS transitions) 적용
- **Feedback**: 
  - 로딩 상태 표시 (스켈레톤 UI)
  - 성공/실패 피드백 (토스트 메시지)
  - 동기화 상태 표시

---

## 5. Supabase 개발 가이드

### 5.1 Supabase 프로젝트 설정
1. **프로젝트 생성**: Supabase 대시보드에서 새 프로젝트 생성
2. **환경 변수 설정**:
   ```env
   VITE_SUPABASE_URL=https://xxx.supabase.co
   VITE_SUPABASE_ANON_KEY=eyJxxx...
   ```
3. **클라이언트 초기화**:
   ```typescript
   import { createClient } from '@supabase/supabase-js'
   
   export const supabase = createClient(
     import.meta.env.VITE_SUPABASE_URL,
     import.meta.env.VITE_SUPABASE_ANON_KEY
   )
   ```

### 5.2 데이터베이스 마이그레이션
1. **테이블 생성**:
   - User (Supabase Auth 자동 생성)
   - Account
   - Stock
   - StockMemo
   - Attachment
2. **RLS (Row Level Security) 설정**:
   - 사용자별 데이터 격리
   - 인증된 사용자만 자신의 데이터 접근 가능
3. **인덱스 생성**:
   - userId, accountId, stockId 등 FK에 인덱스 추가

### 5.3 Storage 설정
1. **버킷 생성**: `stock-images` 버킷 생성
2. **Public 설정**: Public URL 접근 가능하도록 설정
3. **RLS 정책**: 사용자별 업로드/삭제 권한 설정
4. **파일 업로드**:
   ```typescript
   const { data, error } = await supabase.storage
     .from('stock-images')
     .upload(`${userId}/${fileName}`, file)
   ```

### 5.4 Realtime 구독
1. **테이블 구독**:
   ```typescript
   supabase
     .channel('public:stocks')
     .on('postgres_changes', 
       { event: '*', schema: 'public', table: 'stocks' },
       (payload) => {
         // 데이터 업데이트 처리
       }
     )
     .subscribe()
   ```
2. **구독 해제**: 컴포넌트 언마운트 시 구독 해제

---

## 6. 개발 환경 목 데이터 시스템 사용 가이드

### 6.1 목적
다양한 시나리오(큰 수익, 손실, 소액/대규모 포트폴리오 등)를 빠르게 테스트하고 UI 반응성을 검증하기 위해 MSW 기반 목 데이터 시스템을 활용한다.

### 6.2 자동 초기화
개발 서버(`pnpm dev`) 시작 시:
1. MSW 워커가 자동으로 시작됨
2. Supabase API를 모킹하여 로컬 개발 가능
3. 브라우저 콘솔에 사용 가능한 명령어 출력

### 6.3 시나리오 테스트 워크플로우

#### 단계 1: 기본 데이터 확인
```javascript
// 브라우저 콘솔에서 실행
mockUtils.getCurrentData()  // 현재 로드된 데이터 확인
```

#### 단계 2: 시나리오 변경
```javascript
// 큰 수익 케이스 테스트
mockUtils.loadScenario('bigProfit')

// 손실 케이스 테스트
mockUtils.loadScenario('bigLoss')

// 소액 투자자 케이스
mockUtils.loadScenario('smallPortfolio')

// 대규모 포트폴리오 케이스
mockUtils.loadScenario('largePortfolio')
```

#### 단계 3: UI 검증
- 자릿수별 폰트 사이즈 반응형 확인
- 수익/손실 색상 및 아이콘 표시 확인
- 카드 레이아웃 및 정렬 확인
- 반응형 디자인 동작 확인
- 동기화 상태 표시 확인

#### 단계 4: 데이터 초기화
```javascript
// 모든 데이터 삭제 후 재시작
mockUtils.clear()
```

### 6.4 테스트 체크리스트

#### UI 반응성 테스트
- [ ] 1자리 금액 (0원) - 최대 폰트 사이즈 적용 확인
- [ ] 4자리 금액 (1,234원) - 큰 폰트 사이즈 확인
- [ ] 7자리 금액 (1,234,567원) - 중간 폰트 사이즈 확인
- [ ] 10자리 이상 (12,345,678,901원) - 작은 폰트 사이즈 확인

#### 수익/손실 케이스
- [ ] 큰 수익 (+100% 이상) - 색상 및 아이콘 확인
- [ ] 작은 수익 (+5% 미만) - 표시 정확도 확인
- [ ] 작은 손실 (-5% 미만) - 색상 변경 확인
- [ ] 큰 손실 (-30% 이상) - 경고 표시 확인

#### 동기화 테스트
- [ ] 데이터 저장 시 동기화 상태 표시 확인
- [ ] 네트워크 끊김 시 오프라인 모드 전환 확인
- [ ] 온라인 복귀 시 자동 동기화 확인
- [ ] 다중 기기 동기화 시뮬레이션

#### 인증 테스트
- [ ] 로그인/로그아웃 정상 동작 확인
- [ ] 토큰 만료 시 재로그인 유도 확인
- [ ] 권한 없는 데이터 접근 차단 확인

### 6.5 주의사항
- 목 데이터는 **개발 환경에서만** 활성화됨 (`import.meta.env.DEV`)
- 프로덕션 빌드 시 MSW 및 목 데이터 관련 코드는 번들에 포함되지 않음
- Supabase 무료 플랜 제약을 고려하여 대규모 시나리오 테스트 시 주의

---

## 7. 검증 및 배포 프로세스

### 7.1 기능 검증 (QA)
- 브라우저 에이전트를 활용한 시나리오 테스트:
  - 회원가입 → 로그인 → 계좌 추가 → 종목 추가 → 노트 작성 → 이미지 첨부 → 로그아웃
  - 다중 기기 동기화 확인
- 다양한 화면 크기(반응형)에서의 레이아웃 깨짐 확인
- 네트워크 에러 시나리오 테스트 (오프라인 모드)

### 7.2 Supabase 마이그레이션 가이드
1. **스키마 변경 시**:
   - Supabase 대시보드에서 마이그레이션 SQL 실행
   - 또는 Supabase CLI를 사용한 마이그레이션
2. **데이터 백업**:
   - Supabase 자동 백업 활용
   - 필요 시 수동 Export
3. **RLS 정책 업데이트**:
   - 스키마 변경 시 RLS 정책도 함께 업데이트

### 7.3 배포 프로세스
1. **환경 변수 확인**: 프로덕션 Supabase URL 및 Key 설정
2. **빌드**: `pnpm build`를 통해 프로덕션 빌드 성공 여부 확인
3. **배포**: Vercel, Netlify 등 호스팅 서비스에 배포
4. **배포 후 검증**:
   - 로그인/로그아웃 정상 동작 확인
   - 데이터 CRUD 정상 동작 확인
   - 이미지 업로드 정상 동작 확인
   - 다중 기기 동기화 확인

---

## 8. 트러블슈팅 가이드

### 8.1 인증 관련
**문제**: 로그인 후 즉시 로그아웃됨
- **원인**: 토큰 저장 실패 또는 CORS 문제
- **해결**: Supabase 프로젝트 설정에서 허용된 URL 확인

**문제**: 소셜 로그인 실패
- **원인**: OAuth 설정 오류
- **해결**: Supabase 대시보드에서 Google OAuth 설정 확인

### 8.2 데이터 동기화 관련
**문제**: 데이터가 다른 기기에 반영되지 않음
- **원인**: Realtime 구독 실패
- **해결**: 네트워크 연결 확인, Supabase Realtime 활성화 확인

**문제**: 충돌 발생 시 데이터 손실
- **원인**: Last Write Wins 정책
- **해결**: 사용자에게 충돌 알림 표시, 수동 해결 유도

### 8.3 이미지 업로드 관련
**문제**: 이미지 업로드 실패
- **원인**: Storage 권한 또는 용량 초과
- **해결**: RLS 정책 확인, Supabase Storage 용량 확인

**문제**: 이미지 로딩 느림
- **원인**: 네트워크 속도 또는 이미지 크기
- **해결**: 이미지 리사이징, CDN 활용

---

**문서 버전 히스토리:**
- v2.0 (2026-01-31): Supabase 기반으로 전면 개편
  - 사용자 인증 프로세스 추가
  - 데이터 동기화 프로세스 추가
  - Supabase Storage 이미지 업로드 가이드
  - 오프라인 모드 처리 추가
  - 네트워크 에러 처리 가이드
  - Supabase 개발 가이드 추가
- v1.0 (2026-01-20): 초기 작성 (LocalStorage 기반)
